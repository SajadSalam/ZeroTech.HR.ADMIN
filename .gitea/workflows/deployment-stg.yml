name: Docker Build and Push

on:
  push:
    tags:
      - 'ums-ems-vue-admin-stg-v*'

jobs:
  ######## Staging Environment ########
  Build-Stg:
    runs-on: ubuntu-latest
    if: startsWith(gitea.ref, 'refs/tags/ums-ems-vue-admin-stg-v')
    steps:
      - name: Building
        uses: https://${{ secrets.DEVOPS_TOKEN }}:@gitea.ta3leem.dev/devops/cicd-template/templates/node_js_build@main
        with:
          app_name: 'ums-ems-vue-admin'
          docker_registry_url: ${{ vars.CONTAINER_REGISTRY_URL }}
          docker_registry_path: mohesr/ums-ems-vue-admin
          docker_image_tag: stg
          docker_registry_user: ${{ secrets.CONTAINER_REGISTRY_USER }}
          docker_registry_password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
          env_file: ${{ vars.ENV_STG }}
          cicd_tag: ${{ gitea.ref_name }}
  Deploy-stg:
    needs: Build-Stg
    runs-on: ubuntu-latest
    if: startsWith(gitea.ref, 'refs/tags/ums-ems-vue-admin-stg-v')
    container:
      image: 'gitea.ta3leem.dev/devops/infra-base-images/kubectl:${{ vars.KUBECTL_VERSION }}'
      credentials:
        username: ${{ secrets.CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
    steps:
      - name: Deploying
        uses: https://${{ secrets.DEVOPS_TOKEN }}:@gitea.ta3leem.dev/devops/cicd-template/templates/kubernetes_deploy@main
        with:
          app_name: 'ums-ems-vue-admin'
          kubeconfig: ${{ secrets.STG_KUBECONFIG }}